# trimtab-qa-agent — agent-agnostic QA runner with browser automation
#
# Build:  podman build -t trimtab-qa-agent containers/qa-agent/
#
# Auth modes:
#   API key:  podman run --rm -e ANTHROPIC_API_KEY=... trimtab-qa-agent ...
#   OAuth:    podman run --rm -v ~/.claude/.credentials.json:/auth/.credentials.json:ro,Z ...
#
# Run example:
#   podman run -it --rm --network host \
#     -e QA_AGENT=claude \
#     -v ~/.claude/.credentials.json:/auth/.credentials.json:ro,Z \
#     -v ~/1-Projects/myapp/docs/personas:/personas:ro,Z \
#     -v ~/1-Projects/myapp/docs/qa-reports:/reports:Z \
#     trimtab-qa-agent rachel-kim.md
#
# Supports multiple AI agents (QA_AGENT env var):
#   claude  — Claude Code CLI (default)
#   goose   — Goose CLI by Block
#
# Volume :Z suffix needed on Fedora (SELinux). Omit on NixOS.
#
# Versions pinned for reproducibility. Update and rebuild to upgrade.
FROM docker.io/library/node:22-bookworm

# --- System packages ---
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    ripgrep \
    jq \
    sudo \
    ca-certificates \
    gnupg \
    unzip \
    procps \
    # Chromium rendering dependencies (headless still needs these)
    fonts-liberation \
    fonts-noto-cjk \
    fonts-noto-color-emoji \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libcups2 \
    libdbus-1-3 \
    libdrm2 \
    libgbm1 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libxcomposite1 \
    libxdamage1 \
    libxrandr2 \
    xdg-utils \
    # Python for browser-use (encapsulated — not part of our stack)
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# --- Google Chrome Stable ---
# Stable builds are better tested for headless automation than Debian's chromium.
# --no-sandbox is required in unprivileged containers.
RUN curl -fsSL https://dl.google.com/linux/linux_signing_key.pub \
    | gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg \
    && echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] https://dl.google.com/linux/chrome/deb/ stable main" \
    > /etc/apt/sources.list.d/google-chrome.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends google-chrome-stable \
    && rm -rf /var/lib/apt/lists/*

# --- Agent: Claude Code ---
RUN curl -fsSL https://claude.ai/install.sh | bash \
    && cp /root/.local/bin/claude /usr/local/bin/claude

# --- Agent: Goose CLI (Block/Square) ---
RUN curl -fsSL https://github.com/block/goose/releases/download/stable/download_cli.sh \
    | CONFIGURE=false bash \
    && cp /root/.local/bin/goose /usr/local/bin/goose 2>/dev/null || true

# --- Non-root user (UID 1000 for --userns=keep-id) ---
# node:22-bookworm already has user "node" at UID 1000.
# Rename to "agent" for consistency with trimtab-agent pattern.
RUN usermod -l agent -d /home/agent -m node \
    && groupmod -n agent node

USER agent

# --- Pre-create writable dirs ---
# ~/.claude will receive copied credentials at startup (entrypoint.sh)
# /auth is the read-only mount point for host .credentials.json
RUN mkdir -p /home/agent/.claude

USER root
RUN mkdir -p /auth /reports && chown agent:agent /reports

USER agent

# --- browser-use in isolated venv ---
# browser-use is Python but encapsulated here — no Python in our stack.
RUN python3 -m venv /home/agent/.venv \
    && /home/agent/.venv/bin/pip install --no-cache-dir browser-use

# --- Environment ---
ENV TERM=xterm-256color \
    CLAUDE_CODE_DISABLE_AUTO_UPDATE=1 \
    CHROME_PATH=/usr/bin/google-chrome-stable \
    CHROMIUM_FLAGS="--no-sandbox --disable-gpu --disable-dev-shm-usage" \
    PATH="/home/agent/.venv/bin:$PATH"

# --- Entrypoint ---
COPY --chown=agent:agent qa-runner.sh /home/agent/qa-runner.sh
RUN chmod +x /home/agent/qa-runner.sh

# Root wrapper: copies auth credentials then drops to agent user.
# Runs as root to chown the credential copy, then exec's qa-runner as agent.
# Must switch to root BEFORE copying entrypoint (agent can't chmod /).
USER root
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR /work
ENTRYPOINT ["/entrypoint.sh"]
