# trimtab-agent — self-contained Claude Code + Elixir dev environment
#
# Build:  podman build -t trimtab-agent containers/agent/
# Run:    podman run -it --rm --network host --userns=keep-id \
#           -v ~/.claude:/home/agent/.claude:Z \
#           -v ~/1-Projects/my-project:/work:Z \
#           --entrypoint claude trimtab-agent --dangerously-skip-permissions
#
# --userns=keep-id maps your host UID to the same UID inside (agent, 1000).
# This lets --dangerously-skip-permissions work (Claude refuses it as root)
# while keeping volume file ownership correct.
# Volume :Z suffix needed on Fedora (SELinux). Omit on NixOS.
#
# Versions pinned for reproducibility. Update and rebuild to upgrade.
FROM docker.io/elixir:1.19-otp-28

ARG NODE_MAJOR=24

# --- System packages + GitHub CLI ---
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    git-lfs \
    openssh-client \
    ripgrep \
    jq \
    inotify-tools \
    build-essential \
    sudo \
    tmux \
    ca-certificates \
    gnupg \
    unzip \
    && curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
       | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
       > /etc/apt/sources.list.d/github-cli.list \
    && apt-get update && apt-get install -y --no-install-recommends gh \
    && rm -rf /var/lib/apt/lists/*

# --- Node.js LTS ---
RUN curl -fsSL https://deb.nodesource.com/setup_${NODE_MAJOR}.x | bash - \
    && apt-get install -y --no-install-recommends nodejs \
    && rm -rf /var/lib/apt/lists/*

# --- PostgreSQL client (latest from official repo) ---
RUN curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc \
    | gpg --dearmor -o /usr/share/keyrings/postgresql.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt trixie-pgdg main" \
    > /etc/apt/sources.list.d/pgdg.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# --- Claude Code (install as root, copy to system path) ---
RUN curl -fsSL https://claude.ai/install.sh | bash \
    && cp /root/.local/bin/claude /usr/local/bin/claude

# --- Non-root user for agent work ---
# UID 1000 matches typical host user for --userns=keep-id compatibility.
# With --userns=keep-id, the host user maps to this UID inside the container.
RUN useradd -m -u 1000 -s /bin/bash agent

USER agent

# --- Hex + Rebar (installed as agent user) ---
RUN mix local.hex --force && mix local.rebar --force

# --- Environment ---
# TERM: Claude TUI needs a real terminal type
# Auto-update: disabled — image pins the version, updates are lost on container restart
ENV TERM=xterm-256color \
    CLAUDE_CODE_DISABLE_AUTO_UPDATE=1

WORKDIR /work
ENTRYPOINT ["/bin/bash"]
