#!/usr/bin/env bash
# trimtab status - Quick status of running work across projects
# Designed for phone-width SSH sessions (~60 chars)
set -euo pipefail

# --- Colors (raw ANSI, no tput) ---
R=$'\033[0;31m'   # red
G=$'\033[0;32m'   # green
D=$'\033[2m'      # dim
B=$'\033[1m'      # bold
C=$'\033[0;36m'   # cyan
Y=$'\033[0;33m'   # yellow
N=$'\033[0m'      # reset

section() { printf "\n${B}${C}── %s${N}\n" "$1"; }

# --- Port-to-project mapping ---
declare -A PORT_PROJECT=(
  [4000]="(multiple)"
  [4001]="tallmadge"
  [4002]="family_meetup"
  [4003]="akro_backend"
  [4010]="credentialvault"
  [4013]="todd_agent"
  [5173]="credentialvault-fe"
)

# Disambiguate port 4000 by checking process cwd
resolve_4000() {
  local pid="$1"
  local cwd
  cwd=$(readlink -f "/proc/$pid/cwd" 2>/dev/null) || { echo "unknown"; return; }
  basename "$cwd"
}

# ============================================================
# DEV SERVERS
# ============================================================
section "Dev Servers"
found_server=0
while IFS= read -r line; do
  # Extract port and pid from ss output
  port=$(echo "$line" | grep -oP ':(\d+)\s' | head -1 | tr -d ': ')
  pid=$(echo "$line" | grep -oP 'pid=(\d+)' | head -1 | sed 's/pid=//')
  [[ -z "$port" || -z "$pid" ]] && continue
  # Only care about ports in our range
  (( port < 4000 || port > 5200 )) && continue

  project="${PORT_PROJECT[$port]:-}"
  if [[ "$port" == "4000" && -n "$pid" ]]; then
    project=$(resolve_4000 "$pid")
  elif [[ -z "$project" ]]; then
    continue
  fi

  printf "  ${G}●${N} :%s  %s\n" "$port" "$project"
  found_server=1
done < <(ss -tlnp 2>/dev/null | grep -P ':(4\d{3}|51[0-9]{2})\b' || true)

(( found_server == 0 )) && printf "  ${D}none${N}\n"

# ============================================================
# CLAUDE SESSIONS
# ============================================================
section "Claude Sessions"
found_claude=0
while IFS= read -r pid; do
  [[ -z "$pid" ]] && continue
  cwd=$(readlink -f "/proc/$pid/cwd" 2>/dev/null) || continue
  proj=$(basename "$cwd")
  elapsed=$(ps -o etime= -p "$pid" 2>/dev/null | xargs)
  printf "  ${G}●${N} %-20s %s\n" "$proj" "${D}${elapsed}${N}"
  found_claude=1
done < <(pgrep -x claude 2>/dev/null || true)

(( found_claude == 0 )) && printf "  ${D}none${N}\n"

# ============================================================
# GIT — last 24 hours
# ============================================================
section "Git (24h)"
found_git=0
for repo in "$HOME"/1-Projects/*/; do
  [[ -d "$repo/.git" ]] || continue
  proj=$(basename "$repo")
  count=$({ git -C "$repo" log --oneline --since="24 hours ago" 2>/dev/null || true; } | wc -l)
  (( count == 0 )) && continue
  last=$({ git -C "$repo" log --oneline -1 --since="24 hours ago" 2>/dev/null || true; } | cut -c1-50)
  printf "  ${G}%2d${N}  %-16s ${D}%s${N}\n" "$count" "$proj" "$last"
  found_git=1
done

(( found_git == 0 )) && printf "  ${D}no commits${N}\n"

# ============================================================
# DOCKER
# ============================================================
section "Docker"
if command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
  containers=$(docker ps --format '{{.Names}}\t{{.Status}}' 2>/dev/null || true)
  if [[ -n "$containers" ]]; then
    while IFS=$'\t' read -r name status; do
      # Truncate status to fit
      status="${status:0:20}"
      printf "  ${G}●${N} %-22s ${D}%s${N}\n" "$name" "$status"
    done <<< "$containers"
  else
    printf "  ${D}no containers${N}\n"
  fi
else
  printf "  ${D}docker not available${N}\n"
fi

# ============================================================
# SYSTEM
# ============================================================
section "System"
load=$(cut -d' ' -f1-3 /proc/loadavg)
mem_line=$(free -m | awk '/^Mem:/ {printf "%dM / %dM (%.0f%%)", $3, $2, $3/$2*100}')
disk=$(df -h / | awk 'NR==2 {print $3 " / " $2 " (" $5 ")"}')

printf "  load   %s\n" "$load"
printf "  mem    %s\n" "$mem_line"
printf "  disk   %s\n" "$disk"

# ============================================================
# GPU (nixos-thor)
# ============================================================
section "GPU (nixos-thor)"
if timeout 2 ssh -o ConnectTimeout=1 -o BatchMode=yes nixos-thor "echo ok" >/dev/null 2>&1; then
  gpu_info=$(ssh -o ConnectTimeout=1 -o BatchMode=yes nixos-thor \
    "nvidia-smi --query-gpu=name,utilization.gpu,memory.used,memory.total --format=csv,noheader,nounits 2>/dev/null | head -1" 2>/dev/null || echo "")
  if [[ -n "$gpu_info" ]]; then
    IFS=',' read -r gname gutil gmem gtotal <<< "$gpu_info"
    gname=$(echo "$gname" | xargs)
    gutil=$(echo "$gutil" | xargs)
    gmem=$(echo "$gmem" | xargs)
    gtotal=$(echo "$gtotal" | xargs)
    printf "  ${G}●${N} %s\n" "$gname"
    printf "    util %s%%  mem %sM/%sM\n" "$gutil" "$gmem" "$gtotal"
  else
    printf "  ${Y}connected, no GPU data${N}\n"
  fi
  # Container count
  ccount=$(ssh -o ConnectTimeout=1 -o BatchMode=yes nixos-thor \
    "docker ps -q 2>/dev/null | wc -l" 2>/dev/null || echo "0")
  (( ccount > 0 )) && printf "  containers: %d\n" "$ccount"
else
  printf "  ${D}unreachable${N}\n"
fi

printf "\n${D}%s${N}\n" "$(date '+%H:%M %a %b %d')"
